# DiceBag

DiceBag is a library of rake tasks for configuring web apps in the style of [The
Twelve-Factor App][1]. Configuration values are picked up from the environment
and pushed into appropriate configuration files via templates. Pre-packaged
templates for common configuration files are provided.

[1]: http://www.12factor.net/

## Install

Add the following to your `Gemfile`:

```ruby
gem 'dice_bag', :git => 'git@github.com:mdsol/dice_bag.git'
```

If you are using these tasks outside of a Rails project, add the following to
your `Rakefile` or wherever your local rake tasks are defined:

```ruby
require 'dice_bag/tasks'
```

Run the following command to see the new tasks:

```
[bundle exec] rake -D config
```

## Create configuration files from templates

When the rake task `config:all` is run, configuration files in the `config`
directory are generated by looking for ERB template files with the `.erb`
extension in that directory. Configuration values from the environment are made
available to the templates through the `configured` object.

For example, given the `config/database.yml.erb` file contains this template:

```erb
development:
  database: development
  username: <%= configured.database_username || 'root' %>
  password: <%= configured.database_password %>
```

When the following command is run:

```
[bundle exec] rake DATABASE_USERNAME=alice DATABASE_PASSWORD=xyzzy config:all
```

The file `config/database.yml` is generated with this content:

```yaml
development:
  database: development
  username: alice
  password: xyzzy
```

Templates can provide defaults, as in the example above, so running just the
following command:

```
[bundle exec] rake config:all
```

Results in this:

```yaml
development:
  database: development
  username: root
  password: 
```

As discussed in [The Twelve-Factor App section on configuration][2], do not
commit your generated configuration files to source control. Instead, regenerate
them at deployment time by running the rake `config:all` task.

[2]: http://www.12factor.net/config

## Use pre-packaged templates

Pre-packaged templates for the following configuration files in the `config`
directory are provided:

* `database.yml` for [Rails](https://github.com/rails/rails/)
* `newrelic.yml` for [NewRelic](https://github.com/newrelic/rpm)

Run the following command to create the pre-packaged templates in the `config`
directory:

```
[bundle exec] rake config:generate_all
```

These templates can then be used to generate their configuration files by
running the rake `config:all` task. As a shortcut, the rake `config` task does
both of these things for you.

You may commit these pre-packaged templates to source control, although it is
not necessary if your deployment process invokes the rake `config:generate_all`
or `config` tasks. By committing them, you will have explicit control over the
history of the template. However, you will effectively have the same control by
using a fixed version of this gem, for example if you are already committing
your `Gemfile.lock` file.

### Override pre-packaged templates

The intent of the pre-packages templates is that they are as general purpose as
possible. If any template does not fulfill your needs, please submit a patch or
open an issue in GitHub.

As a last resort, you can override a pre-packaged template with a local variant.
These local templates are suffixed with `.local`. For instance, if you have a
`database.yml.erb.local` file, this file will be used instead of the
pre-packaged `database.yml.erb` to generate `database.yml`.

Unlike the pre-packaged templates, your local override templates are never
overwritten. However, they will never automatically benefit from improvements
made in the pre-packaged templates. Therefore, we strongly recommend using and
improving the pre-packaged templates instead of depending on local overrides.

### Limit the pre-packaged templates generated

If you are transitioning to using this gem, you may want to use some but not all
of the pre-packaged templates. One way to do this is to create your own rake
task for the job, like this:

```ruby
task :limited_config do
  command = DiceBag::Command.new
  command.write('database.yml.erb')
  # Repeat calls to `write` here as necessary. 
end
```

### Define your own pre-packaged templates

If you want DiceBag to generate your own pre-packaged templates when you run the
rake `config:generate_all` task, you can create a plug-in. Read the
`templates.md` file to learn how to do this.

## Owners

* [Andrew Smith](mailto:asmith@mdsol.com)
* [Jordi Carres](mailto:jcarres@mdsol.com)
